Root    ?= ../../.. ;
Location = prog/engine/shaders ;

TargetType  = lib ;
Target      = engine/shaders.lib ;

CamStub ?= yes ;
ShaderVarsStub ?= no ;

Sources =
  shaderVariableInfo.cpp
  bindumpReloadListener.cpp
  overrideStates.cpp
  renderStates.cpp
  shadersBinaryDataDbg2.cpp
  shaderBlock.cpp
  globVarsBlk.cpp
  postFxRenderer.cpp
  shStateBlk.cpp
  shStateBlkClose.cpp
  shStateBlkData.cpp
  shaders_globdata.cpp
  scene_binload.cpp
  shaderMesh.cpp
  shaderMeshSimple.cpp
  shaderResUnitedData.cpp
  shUtils.cpp
  shUtilsEx.cpp
  dynamicShaderHelper.cpp
  dynamicShadersBuffer.cpp
  dynShaderBuf.cpp
  debugPrimitivesVbuffer.cpp
  scene.cpp
  scene_vis.cpp
  shadersBinaryDataLoad.cpp
  shadersBinaryDataDbg.cpp
  shadersDbg.cpp
  shadersCon.cpp
  scriptSElem.cpp
  scriptSMat.cpp
  shaders.cpp
  shadersRes.cpp
  shFunc.cpp
  shSkinnedMesh.cpp
  dynSceneRes.cpp
  dynSceneWithTreeRes.cpp
  objVisDebugData.cpp
  rendInstRes.cpp
  instShaderMeshRes.cpp
  matVdata.cpp
  matVdataLoad.cpp
  shaderMeshTexLoadCtrl.cpp
  computeShaders.cpp
  meshShaders.cpp
  sh_vars.cpp
  shMaterialUtils.cpp
  shStateBlockBindless.cpp
  shStateBlockSlotTextures.cpp
  shAssert.cpp
  bindposeBufferManager.cpp
;

if $(ShaderVarsStub) = no {
  Sources +=
    shadersBinaryDataVars.cpp
  ;
} else {
  Sources +=
    shadersBinaryDataVarsStub.cpp
  ;
}


AddIncludes =
  $(Root)/1stPartyLibs
  $(Root)/prog/engine/sharedInclude
;

UseProgLibs +=
  3rdPartyLibs/eastl
  3rdPartyLibs/meshoptimizer
;

if $(ShadersAllowAltBindump) = yes || $(BuildingTools) = yes {
  Target = $(Target:S=-2.lib) ;
  CPPopt += -DSHADERS_ALLOW_2_BINDUMP ;
}
if $(ShadersMeasurePerf) = yes {
  Target = $(Target:S=-p.lib) ;
  CPPopt += -DMEASURE_STCODE_PERF ;
}

if $(Platform)-$(PlatformArch) = windows-x86_64 && $(SSEVersion) != 4 {
  CppStcode = disable ;
}

if $(CppStcode) = enable {
  Target = $(Target:S=-stcpp.lib) ;
  Sources +=
    stcode.cpp
    stcode/stcodeCallbacksImpl.cpp
  ;
  CPPopt += -DCPP_STCODE ;
} else if $(CppStcode) = both {
  Target = $(Target:S=-stboth.lib) ;
  Sources +=
    stcode.cpp
    stcode/stcodeCallbacksImpl.cpp
  ;
  CPPopt += -DCPP_STCODE -DSTCODE_RUNTIME_CHOICE ;
} else if $(CppStcode) = validate {
  Target = $(Target:S=-stcpp-val.lib) ;
  Sources +=
    stcode.cpp
    stcode/stcodeCallbacksImpl.cpp
    stcode/compareStcode.cpp
  ;
  CPPopt += -DCPP_STCODE -DVALIDATE_CPP_STCODE ;
} else {
  CppStcodeMode = ;
}

if $(CppStcodeMode) = branched {
  Target = $(Target:S=-branched.lib) ;
  CPPopt += -DCPP_STCODE_DYNAMIC_BRANCHING ;
}

if $(CamStub) = yes {
  Target = $(Target:S=-cs.lib) ;
  CPPopt += -DCAM_STUB ;
}

if $(ProfileStcode) = yes {
  Target = $(Target:S=-sp.lib) ;
  Sources += profileStcode.cpp ;
  CPPopt += -DPROFILE_STCODE ;
}

include $(Root)/prog/_jBuild/build.jam ;
